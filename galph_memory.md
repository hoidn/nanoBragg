## 2025-09-30
- Reviewed current repo state; no prior galph memory.
- Identified critical outstanding parity failures (AT-020/021/022/024). AT-021 phi rotation bug is root cause for AT-022.
- Per long-term goals, PyTorch still shows major parity gaps plus performance overhead (torch.compile warm-up dominates small detectors; large crystal case still ~7√ó slower vs C). Potential optimizations: share compiled kernels across instances, real geometry caching, consider chunked evaluation to trim memory.
- Created supervisor plan for AT-021 debugging at `plans/active/at-parallel-021/plan.md`; cross-referenced from fix_plan. This plan should be the next loop (requires prompts/debug.md).
- Observed Ralph‚Äôs recent loops mainly documentation/perf; no regressions but backlog untouched. Next action for Ralph: run debug loop against AT-021 using new plan.

## 2025-09-30 (galph loop 2)
- Deep dive confirmed AT-PARALLEL-024 failure stems from the random misset cap mismatch: PyTorch clamps to œÄ/2 (`src/nanobrag_torch/models/crystal.py:594-603`) while C uses the raw `90.0` argument as radians (`golden_suite_generator/nanoBragg.c:2010-2016`). Documented evidence in fix_plan and opened dedicated plan at `plans/active/at-parallel-024/plan.md` with phased instructions.
- Verified AT-PARALLEL-021/022 parity now pass after commit 8293a15; updated `docs/fix_plan.md` to mark both complete and to record new metrics + unit-test alignment (`tests/test_suite.py:167-207`). Plan 021 can be archived once Ralph confirms AT-022 stays green in his next loop.
- Performance review: benchmarks (`reports/benchmarks/20250930-111451/benchmark_results.json`) still show PyTorch ‚â•10√ó slower than C for ‚â§1k detectors; primary culprits are per-instance `torch.compile` wrapping in `Simulator.__init__` and repeated constant tensor creation inside `_compute_physics_for_position`. Flag for future perf initiative.
- Ralph review: last seven loops (`RALPH-ROUTING-001`‚Ä¶`RALPH-VERIFICATION-007`) repeatedly re-ran the full suite without debugging, even mislabeling the phi fix as a regression (`d702171`). Next guidance: insist Ralph route through `prompts/debug.md` for outstanding ATs and avoid further verification-only loops.
- VC hygiene: committed plan+fix_plan update (`SUPERVISOR: at-parallel-024 parity plan - tests: parity AT-021/022`). Worktree remains dirty from pre-existing artifacts (e.g., `tests/test_suite.py`, `parallel_test_visuals/*`, `trash/test_parity_matrix.py`); do not stage these on the next loop without user direction.
- Next steps for Ralph: execute the new AT-024 plan under `prompts/debug.md`, reproduce misset angles against C, and implement the 90-radian cap fix.

## 2025-09-30 (galph loop 3)
- Deep analysis: `_compute_physics_for_position` is still wrapped by `torch.compile` inside every `Simulator` ctor (per-run warm-up 0.5‚Äì6s). Constants like `torch.tensor(1e-12, device=...)` are created inside the compiled path, forcing Dynamo to materialize tensors each call; recommend caching via `.new_tensor()` or lifting constants alongside a shared compiled kernel. Random misset fix in commit ac29c4f now mirrors C's 90-radian bug‚Äîparity restored but we still need a follow-up story before calling the PyTorch port ‚Äúbetter than C‚Äù.
- Ralph review (last ~20 commits): positives ‚Äî ac29c4f fixed AT-024 parity, d9d0a06 finally gathered first divergence for AT-012; negatives ‚Äî repeated routing violations and contradictory fix_plan statuses caused the triclinic work to stall. Commit 92ac528 accidentally dragged the entire `golden_suite_generator/nanoBragg.c` binary diff; watch for unnecessary churn in future loops.
- Planning: opened `plans/active/at-parallel-012/plan.md` to drive the rotation-matrix investigation (Phase A‚ÄìE). Updated `docs/fix_plan.md` to mark AT-012 as active, supersede the ‚Äúprecision-only‚Äù conclusion, and point Ralph at the new plan.
- Next Ralph steps: run prompts/debug.md, execute Phase A of the AT-012 plan (dump C vs PyTorch rotation matrices), then march through the plan. Avoid verification loops until AT-012 closes; flag any binary churn (like re-adding full C sources) before committing.

## 2025-09-30 (galph loop 4)
- Deep performance review: `_compute_physics_for_position` still recompiles per `Simulator` instance and allocates inline tensors (`torch.tensor(1e-12)`, repeated `unsqueeze`/`expand`), blocking kernel fusion; `Crystal.compute_cell_tensors` guard clauses (`torch.maximum(..., torch.tensor(...))`) introduce Dynamo graph breaks. Benchmarks (`reports/benchmarks/20250930-002124/benchmark_results.json`) confirm cold runs pay 4.8‚ÄØs compile, warm runs still ‚âà0.52‚ÄØs sim at 256¬≤, keeping PyTorch ~2.7√ó slower than C.
- Heads outcome: reviewed last ~25 Ralph commits. Positives ‚Äî 8293a15 fixed phi rotation parity; ac29c4f restored AT-024. Negatives ‚Äî repeated verification-only loops (0d7eb13), misleading regression report (d702171), and 92ac528 accidentally committed a full `golden_suite_generator/nanoBragg.c` replacement plus large binary churn (needs future cleanup guidance).
- New multi-turn plan opened at `plans/active/perf-pytorch-compile-refactor/plan.md` and cross-referenced from `[PERF-PYTORCH-004]` in `docs/fix_plan.md`. Plan focuses on hoisting constants, sharing compiled kernels, and removing graph breaks before attempting fusion. Fix_plan active list updated accordingly.
- Follow-ups for Ralph: route via perf/debug prompt, execute Plan Phase 0‚Äì1 first (cache design + constant hoisting), then re-benchmark; also flag large C churn from 92ac528 before the next commit. Outstanding dirty artifacts (parallel_test_visuals/*, scratch, trash/test_parity_matrix.py) pre-existed this loop.
- Committed `SUPERVISOR: perf roadmap plan - tests: not run` and pushed; worktree intentionally left with prior untracked parity outputs.

## 2025-09-30 (galph loop 5)
- Step 1 analysis: PyTorch path still recompiles per `Simulator` init; `_compute_physics_for_position` allocates inline `torch.tensor(...)` constants and `torch.maximum(..., torch.tensor(...))` clamps that force new tensors every call. `Crystal.compute_cell_tensors` repeats the same pattern and the `.item()`-based interpolation toggle still severs gradients. Fresh CPU benchmarks (`reports/benchmarks/20250930-004916/benchmark_results.json`) show small detectors paying ~3.7‚ÄØs compile vs C at 16‚ÄØms, confirming the warm-up penalty; only ‚â•1024¬≤ grids hit parity/speedup. Need constant hoisting + shared compile cache before pursuing fusion.
- Housekeeping: Archived stale plans for AT-021 and AT-024 to `plans/archive/...` and flipped status headers to 'Archived 2025-09-30'. Updated `docs/fix_plan.md` to point at the archive paths and record the archive action. Active plans now limited to AT-012 rotation divergence and PERF-PYTORCH-004.
- Coin toss = heads. Commit review (last ~30): üëç ac29c4f finally fixed AT-024 parity with matching misset angles; d9d0a06 captured the triclinic first divergence. ‚ö†Ô∏è 92ac528 dragged a 4.5k-line `nanoBragg.c` dump plus reports assets into history‚Äîneed follow-up cleanup. ‚ö†Ô∏è Ralph continues to ship `RALPH-VERIFICATION-00*` verification loops instead of routing through prompts/debug.md, so agent error-correction remains priority.
- Guidance for Ralph: stay on the AT-012 plan (Phase A rotation matrix comparison, Phase B lattice trace) until correlation ‚â•0.9995; perf work should start Phase 1 hoisting only after AT-012 moves. Also call out the 92ac528 churn before touching C again.
- Outstanding dirt predates this loop (.claude, parallel_test_visuals/*, scratch, trash/test_parity_matrix.py, new benchmark output). No new artifacts beyond plan moves and fix_plan update.

## 2025-09-30 (galph loop 6)
- `git pull --rebase` blocked by long-standing dirty artifacts (`parallel_test_visuals/*`, `.claude`, `trash/test_parity_matrix.py`, etc.); left untouched per policy.
- Deep analysis reiterated two blockers toward long-term goals: (1) `_compute_physics_for_position` still wraps `torch.compile` per `Simulator` instantiation and spawns fresh constants (`torch.tensor(1e-12, ...)`), preventing reuse/fusion (`src/nanobrag_torch/simulator.py:143-199`); (2) `Crystal` toggles interpolation via `.item()` on differentiable tensors, severing gradients (`src/nanobrag_torch/models/crystal.py:114-118`). Benchmarks in `reports/benchmarks/20250930-004916/` confirm small detectors pay 3.7‚ÄØs warm-up vs 16‚ÄØms C.
- Coin = heads. Commit review (last ~30): positives ‚Äî `ac29c4f` (AT-024 parity) and `d9d0a06` (AT-012 first divergence) added high-value debugging artifacts. Negatives ‚Äî `d702171` mislabeled a non-regression and `0d7eb13` continued verification-only loops; `92ac528` still sits with a 4.6k-line `golden_suite_generator/nanoBragg.c` churn + stray reports, obscuring C diffs.
- Planning: Existing AT-012 and PERF-PYTORCH-004 plans remain valid; no new multi-turn plans required. Instead updated `docs/fix_plan.md` ‚Äî cleared stale AT-020 status, logged `REPO-HYGIENE-002` to clean the 92ac528 churn, and cross-referenced benchmarks.
- Next Ralph actions: follow AT-012 plan (Phases A/B), execute `REPO-HYGIENE-002` under `prompts/main.md`, then resume PERF-PYTORCH-004 Phase 1 constant hoisting. Flag inability to run `git pull --rebase` until legacy artifacts are addressed.
