--- /tmp/loop-guard-baseline.sh	2025-10-01 05:25:12.366848432 -0700
+++ supervisor.sh	2025-10-01 05:14:35.441902911 -0700
@@ -1,34 +1,51 @@
 #!/usr/bin/env bash
 set -euo pipefail
 
-# --- Activate the conda environment required for Claude automation ---
+# --- Activate the conda environment required for supervisor automation ---
 source "$(conda info --base)/etc/profile.d/conda.sh"
 conda activate pytorch
-# --------------------------------------------------------------------
+# -----------------------------------------------------------------------
 
 # Sync with remote before starting work
 timeout 30 git pull --rebase || {
-  echo "WARNING: git pull --rebase failed or timed out. Proceeding with local state."
+  # Check if we're in mid-rebase
+  if [ -d .git/rebase-merge ] || [ -d .git/rebase-apply ]; then
+    echo "WARNING: Rebase in progress detected after timeout. Aborting rebase..."
+    git rebase --abort 2>/dev/null || true
+    echo "WARNING: Attempting non-rebase pull as fallback..."
+    git pull --no-rebase || {
+      echo "WARNING: Both rebase and merge pulls failed. Proceeding with local state."
+    }
+  else
+    echo "WARNING: git pull --rebase failed or timed out. Proceeding with local state."
+  fi
 }
 
+# Prepare a timestamped log for supervisor runs.
 mkdir -p tmp
 TS=$(date '+%Y%m%d_%H%M%S')
-LOG_FILE="tmp/claudelog${TS}.txt"
-ln -sf "${LOG_FILE}" tmp/claudelog-latest.txt
+LOG_FILE="tmp/supervisorlog${TS}.txt"
+ln -sf "${LOG_FILE}" tmp/supervisorlog-latest.txt
 
-CLAUDE_CMD="/home/ollie/.claude/local/claude"
+CODEX_CMD="codex"
 
-# Execute debug prompt once per invocation
-# Note: Using debug.md per routing guard while AT parity suite incomplete
-cat prompts/debug.md | "${CLAUDE_CMD}" -p --dangerously-skip-permissions --verbose --output-format stream-json | tee -a "${LOG_FILE}"
-
-# Conditional push: only if there are commits to push and no errors occurred
-if git diff --quiet origin/$(git rev-parse --abbrev-ref HEAD)..HEAD 2>/dev/null; then
-  echo "No new commits to push."
+# Execute supervisor prompt once per invocation
+# Note: External orchestration (e.g., cron, manual runs) controls repetition
+${CODEX_CMD} exec -m gpt-5-codex -c model_reasoning_effort="high" --dangerously-bypass-approvals-and-sandbox < prompts/supervisor.md | tee -a "${LOG_FILE}"
+SUPERVISOR_EXIT=$?
+
+# Conditional push: only if there are commits to push and execution succeeded
+if [ $SUPERVISOR_EXIT -eq 0 ]; then
+  if git diff --quiet origin/$(git rev-parse --abbrev-ref HEAD)..HEAD 2>/dev/null; then
+    echo "No new commits to push."
+  else
+    echo "Pushing commits to remote..."
+    git push || {
+      echo "WARNING: git push failed. Please push manually."
+      exit 1
+    }
+  fi
 else
-  echo "Pushing commits to remote..."
-  git push || {
-    echo "WARNING: git push failed. Please push manually."
-    exit 1
-  }
+  echo "WARNING: Supervisor execution failed (exit code: $SUPERVISOR_EXIT). Skipping push."
+  exit $SUPERVISOR_EXIT
 fi
