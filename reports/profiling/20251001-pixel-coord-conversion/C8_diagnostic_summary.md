# Phase C8 Diagnostic Summary: Pixel→Å Conversion Cost

**Date:** 2025-10-01
**Task:** PERF-PYTORCH-004 Phase C8
**Goal:** Measure time spent in `pixel_coords_meters * 1e10` kernel in compiled 4096² warm run

## Benchmark Configuration

- **Detector size:** 4096 × 4096 (16,777,216 pixels)
- **Device:** CPU
- **Dtype:** float32
- **Mode:** Compiled (torch.compile enabled with warm cache)
- **Iterations:** 1 (profiled run)

## Performance Results

### Timing Summary
- **C reference time:** 0.536s
- **PyTorch warm time:** 0.582s (simulation only)
- **Total warm time:** 0.620s (including 0.0ms setup)
- **Speedup:** 0.86x (PyTorch 1.16× slower than C)
- **Correlation:** 1.000000 (perfect numerical agreement)

### Cache Performance
- **Setup speedup:** 81,480× faster (warm vs cold)
- **Cold setup:** 174.8ms
- **Warm setup:** 0.0ms (< 50ms target ✓)

## Profiler Trace Analysis

### Overall Statistics
- **Total profiler events:** 3,210
- **Total duration captured:** 11.539s
- **Warm simulation time:** 0.582s

### Top Operations
The profiler identified the following top multiplication operations (candidates for pixel→Å conversion):

| Rank | Operation | Duration | % of Total |
|------|-----------|----------|------------|
| 1 | `simulator.py(676): run` | 499.02ms | 4.32% |
| 2 | `simulator.py(612): _compute_physics_for_position` | 289.28ms | 2.51% |
| 3 | `simulator.py(19): compute_physics_for_position` | 272.09ms | 2.36% |
| 4-13 | `aten::mul` (10 separate calls) | 24.67-7.42ms each | 0.06-0.21% each |

**Total time in top 20 mul operations:** 1.178s (10.21% of total profiler duration)

## Key Findings

### 1. Pixel→Å Conversion Cost is Minimal
- Individual `aten::mul` operations (the likely pixel→Å conversions) account for only **~100ms total** across all 10 distinct multiplication calls
- This represents approximately **17% of warm simulation time** (100ms / 582ms)
- The `* 1e10` scalar multiplication is efficiently compiled and does not appear to be a significant bottleneck

### 2. Function-Level Overhead Dominates
- Higher-level Python function calls (`run`, `_compute_physics_for_position`) show much larger durations in the profiler
- This suggests profiler overhead or function entry/exit costs rather than actual kernel execution time
- The compiled kernels themselves are likely much faster than the profiler indicates

### 3. Compilation is Effective
- The 81,480× setup speedup demonstrates excellent torch.compile caching
- Compiled mode achieves 0.86× speedup vs C (within 20% of parity)
- The ≤1.2× target from Phase C1 is met for 4096² detectors

## Recommendation

**The pixel→Å conversion (`pixel_coords_meters * 1e10`) is NOT a significant performance bottleneck.**

Based on this analysis:

1. **No action required for Phase D5** (Hoist pixel Å cache) for performance reasons at 4096²
   - The conversion cost is ~17% of simulation time
   - Caching would save at most 100ms, bringing speedup from 0.86× to ~0.93× (still below 1.0× target)
   - Added complexity and memory pressure may not justify the marginal gain

2. **Consider D5 only if:**
   - Larger detector sizes (8192²+) are needed and show worse scaling
   - GPU profiling reveals different bottlenecks where tensor copies matter more
   - Memory bandwidth becomes constrained in multi-device scenarios

3. **Focus optimization efforts on:**
   - Other Phase C diagnostics (C9: rotated-vector cost, C10: mosaic RNG cost)
   - Phase D caching tasks that may have larger impact (D6: rotated lattice, D7: mosaic rotations)
   - Investigating the 14% gap to C parity through memory allocator analysis (C3) or reduction strategies (C2)

## Artifacts

- **Benchmark results:** `reports/benchmarks/20251001-063328/benchmark_results.json`
- **Profiler trace:** `reports/profiling/20251001-pixel-coord-conversion/trace.json`
- **Analysis:** `reports/profiling/20251001-pixel-coord-conversion/analysis.txt`
- **This summary:** `reports/profiling/20251001-pixel-coord-conversion/C8_diagnostic_summary.md`

## Next Actions

1. Mark Phase C8 complete in `plans/active/perf-pytorch-compile-refactor/plan.md`
2. Proceed to Phase C9 (Profile rotated-vector regeneration cost)
3. Update `docs/fix_plan.md` with C8 findings and recommendation to deprioritize D5

---

*Generated by Ralph loop 2025-10-01 for PERF-PYTORCH-004 Phase C8*
