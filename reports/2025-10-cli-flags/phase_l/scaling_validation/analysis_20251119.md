# Phase L3e Scaling Validation Snapshot — 2025-11-19

**Focus:** CLI-FLAGS-003 (`-nonoise`/`-pix0_vector_mm`) — investigate why the supervisor command still shows a 24% scale drift after HKL wiring fixes.

## Inputs
- `TRACE_C`: `reports/2025-10-cli-flags/phase_l/scaling_audit/c_trace_scaling.log`
- `TRACE_PY`: `reports/2025-10-cli-flags/phase_l/scaling_audit/trace_py_scaling_20251117.log`
- Comparison tool: `scripts/validation/compare_scaling_traces.py`
- Output summary: `scaling_validation_summary_20251119.md`
- Metrics JSON: `metrics.json`
- Run metadata: `run_metadata.json`

## Key Findings

1. **First divergence remains `I_before_scaling`.**
   - C: `943654.80923755` (`c_trace_scaling.log:288`)
   - PyTorch: `713431` (`trace_py_scaling_20251117.log:27`)
   - Relative delta: `-0.243970366` (−24.4%), status **CRITICAL** (`metrics.json`)

2. **Structure factor ingestion now matches C.**
   - `F_cell` = `190.270004272461` in PyTorch trace (`trace_py_scaling_20251117.log:26`)
   - C trace same value within 2.4e-6 (`c_trace_scaling.log:280-287` via Phase L3a probe)
   - Confirms the remaining gap is downstream of HKL lookup.

3. **Lattice shape factor (`F_latt`) diverges in sign and magnitude.**
   - PyTorch: `F_latt = 1.35136013608642` (`trace_py_scaling_20251117.log:24`)
   - C: `F_latt = -2.38319665299058` (`c_trace_scaling.log:288`)
   - C per-φ entries oscillate in sign (see `c_trace_scaling.log:280-287`), whereas PyTorch logs no per-φ breakdown. This mismatch explains the residual 24% `I_before_scaling` error.

4. **Downstream scaling factors remain within tolerance.**
   - `r_e^2`, `fluence`, `steps`, `capture_fraction` all `PASS` (≤1e-6 rel delta)
   - `polar`, `omega_pixel`, `cos_2theta`: MINOR drift (1.8e-6 → 1.9e-5 rel), consistent with prior audits and below L3e thresholds.

5. **Final intensity delta tracks the raw accumulation gap.**
   - `I_pixel_final` ratio mirrors the `I_before_scaling` mismatch (−17.3% delta, status **CRITICAL**).

## Implications for Phase L3

- **Immediate target:** reconcile the lattice factor pipeline. PyTorch’s `_compute_structure_factor_components` (or equivalent) must reproduce the φ-step accumulation and sign oscillations visible in `TRACE_C_PHI` lines 280–287.
- **Suggested diagnostic:** extend PyTorch trace instrumentation to emit per-φ `F_latt` contributions (`TRACE_PY_PHI`) so we can pinpoint where the sign flip disappears.
- **Next evidence step:** once per-φ parity is confirmed, rerun `compare_scaling_traces.py` and expect `I_before_scaling` to align within ≤1e-6.

## Artifacts Produced

| Artifact | Purpose |
| --- | --- |
| `scaling_validation_summary_20251119.md` | Updated factor-by-factor delta table using latest trace |
| `metrics.json` | Structured deltas (overwrites prior Phase L2c output) |
| `run_metadata.json` | Command reproduction metadata (git SHA, torch version, tolerance) |
| `analysis_20251119.md` *(this file)* | Narrative linking `I_before_scaling` gap to `F_latt` mismatch |

## Recommended Hand-off to Ralph

1. Instrument per-φ `TRACE_PY_PHI` logging for lattice accumulation (Phase L3e → L3f prep).
2. Compare against `TRACE_C_PHI` entries (`c_trace_scaling.log:280-287`), identify first φ-step divergence.
3. Update fix_plan Attempt history with these findings before modifying simulator code.

