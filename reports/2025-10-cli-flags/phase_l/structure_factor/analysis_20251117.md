# Structure-Factor Coverage Analysis

**Date:** 2025-10-07T07:23:29.479460Z
**Task:** CLI-FLAGS-003 Phase L3a
**Goal:** Verify structure-factor source for supervisor pixel

## Target Reflection

- **Miller index:** h=-7, k=-1, l=-14
- **C reference F_cell:** 190.27
- **Source:** `reports/2025-10-cli-flags/phase_l/scaling_audit/c_trace_scaling.log:143-164`

## Data Sources Tested

See `probe_20251117.log` for detailed output from:
- `scaled.hkl` (HKL text file)
- Fdump binary: `reports/2025-10-cli-flags/phase_l/hkl_parity/Fdump_scaled_20251006175946.bin` (not found)

## Findings

### HKL File Coverage (scaled.hkl)

**Result: ✅ TARGET REFLECTION FOUND WITH CORRECT VALUE**

- **Grid shape:** torch.Size([49, 57, 62])
- **Grid ranges:**
  - H range: [-24, 24]
  - K range: [-28, 28]
  - L range: [-31, 30]
- **Target in range:** TRUE ✅
- **Retrieved F_cell:** 190.27000427246094
- **Delta from C:** 4.272460927268185e-06 (≈0.000002%)

### Fdump Coverage

**File:** `reports/2025-10-cli-flags/phase_l/hkl_parity/Fdump_scaled_20251006175946.bin`
**Status:** SKIP (file not found at specified path)

## Critical Discovery: Data Exists, Configuration Gap Confirmed

**The data is present and correct.** The probe demonstrates conclusively that:

1. **`scaled.hkl` contains the target reflection** with F=190.27, exactly matching the C reference within numerical precision.
2. **The grid range fully encompasses** the supervisor pixel's Miller index h=-7, k=-1, l=-14.
3. **PyTorch lookup logic works** — `Crystal.get_structure_factor` retrieves the correct value when HKL data is properly attached.

### Root Cause Hypothesis (Updated 2025-11-17)

The F_cell=0 divergence in `trace_py_scaling.log` **stems from configuration/loading, NOT missing coverage:**

- The HKL file exists and contains all required reflections.
- The PyTorch lookup infrastructure is correct (proven by probe success).
- **The harness or CLI is failing to load/attach the HKL data before simulation.**

This aligns with Attempt #76 findings and confirms Phase L3b's focus: audit the harness attachment pattern.

## Next Actions (Phase L3b → L3c)

### L3c: Harness Audit (Immediate)

1. **Review `reports/2025-10-cli-flags/phase_l/scaling_audit/trace_harness.py` lines 206-236** to identify why HKL data isn't loaded despite `scaled.hkl` containing 168k reflections.
2. **Compare against probe successful pattern:**
   ```python
   F_grid, metadata = read_hkl_file(...)
   crystal.hkl_data = F_grid
   crystal.hkl_metadata = metadata
   ```
3. **Fix harness** to mirror probe's successful attachment pattern.

### L3d: CLI Verification

1. **Audit `src/nanobrag_torch/__main__.py`** to ensure `-hkl` flag loading follows the same pattern.
2. **NO `simulator.py` changes needed** — scaling math is correct per L2c; lookup logic works per this probe.

### L3d: Regression Tests

1. **Extend `tests/test_cli_scaling.py`** with structure-factor lookup assertion for hkl=(-7,-1,-14) using `scaled.hkl`.
2. **Validate retrieval** of F=190.27 and end-to-end intensity matching C reference (≤1e-6 relative tolerance).
3. **Parametrise** over CPU/CUDA.

### L4: Parity Rerun (After L3 fixes)

Execute supervisor command end-to-end, capture nb-compare metrics, confirm:
- Correlation ≥0.9995
- Sum_ratio 0.99-1.01
- Archive results and close CLI-FLAGS-003

## Conclusion

**Phase L3a COMPLETE.** The HKL coverage is confirmed; the gap is in configuration, not data. Proceed to L3c harness audit.
