# Phase C Remediation Plan — CLI-DEFAULTS-001

**Timestamp:** 2025-10-10T16:19:25Z  
**Initiative:** CLI-DEFAULTS-001 (Minimal `-default_F` CLI invocation)  
**Scope:** Document the implementation blueprint to fix the HKL assignment bug and ensure the CLI fallback path mirrors the working API behaviour.

## Current Findings Recap
- Phase B callchain analysis (2025-10-10T16:09:02Z) identified that `src/nanobrag_torch/__main__.py:443` pre-seeds `config['hkl_data'] = None` and that the later guard at line 1090 treats the mere presence of the key as “data available.”
- As a result, the CLI path always executes the HKL assignment block and overwrites `crystal.hkl_data` with a detached tensor, suppressing the `default_F` fallback (`Crystal.get_structure_factor`, `src/nanobrag_torch/models/crystal.py:225-233`).
- Direct API code path does not touch `hkl_data` when no HKL file is supplied, so the simulator emits the expected non-zero intensities.

## Implementation Hypothesis
1. **Stop pre-populating `config['hkl_data']` with `None`.** Allow the key to be absent unless an HKL/FDUMP artifact was successfully loaded (`parse_and_validate_args`, `__main__.py:434-456`).
2. **Harden the guard around HKL assignment.** Replace the current `if 'hkl_data' in config and config['hkl_data'] is not None:` block (lines 1090-1098) with a strictly truthy check that the tuple exists and contains data:
   ```python
   hkl_entry = config.get('hkl_data')
   if hkl_entry is not None:
       hkl_array, hkl_metadata = hkl_entry
       if hkl_array is not None:
           ...
   ```
   This preserves compatibility with déjà-loaded HKL tuples while keeping the default_F-only path untouched.
3. **Maintain device/dtype neutrality.** When reassigning `crystal.hkl_data`, continue to clone/detach only when source is a tensor; non-tensor inputs should be converted with `torch.tensor(..., device=device, dtype=dtype)` exactly as today.
4. **Guard against stray `Fdump.bin`.** Ensure the loader helper (`try_load_hkl_or_fdump`) surfaces `(None, None)` only when a legitimate cache hit existed; otherwise, it should return `None`. This check prevents older Fdump artifacts from reintroducing the bug. (Confirm behaviour in `src/nanobrag_torch/io/hkl.py` before coding.)

## Step-by-Step Execution Plan (for Ralph)

| Step | Description | Files | Notes |
| --- | --- | --- | --- |
| C1.1 | Update `parse_and_validate_args` to stop inserting the `hkl_data` key on startup. | `src/nanobrag_torch/__main__.py` lines 432-456 | Prefer deleting the sentinel assignment (`config['hkl_data'] = None`) and rely on helper return value checks. |
| C1.2 | Tighten HKL assignment guard using `config.get` semantics. | `src/nanobrag_torch/__main__.py` lines 1087-1100 | Ensure the guard gracefully handles `(None, None)` returns and logs nothing when no HKL file was provided. |
| C1.3 | Add defensive assertion (optional) to warn when CLI path injects empty HKL data while default_F > 0. | Same as above | Log via existing debug/tap scaffolding (guarded by debug flag) to avoid user-facing noise. |
| C2.1 | Validate `try_load_hkl_or_fdump` return contract; adjust to return `None` instead of `(None, None)` when no cache is present. | `src/nanobrag_torch/io/hkl.py` | Confirm that tests covering HKL caching remain satisfied; update docstrings/comments when changing behaviour. |
| C3.1 | Add unit/regression test ensuring CLI default_F path leaves `crystal.hkl_data` unset. | `tests/test_at_cli_002.py` (or new targeted test) | TDD: parametrize to capture both CLI and API control paths if feasible. |
| C3.2 | Document the fix in `docs/fix_plan.md` Attempt #5 and refresh `[CLI-DEFAULTS-001]` Next Actions. | `docs/fix_plan.md` | Include artifact references and emphasise that default_F fallback is covered. |
| C3.3 | Update user-facing documentation (e.g., `README_PYTORCH.md`) with a minimal default_F example. | `README_PYTORCH.md` | Keep consistent with spec `AT-CLI-002`. |

## Acceptance Criteria
- `pytest -v tests/test_at_cli_002.py::TestAT_CLI_002::test_minimal_render_with_default_F` passes.
- Float image generated by CLI default_F-only invocation has non-zero `max`, `sum`, and `np.count_nonzero` (captured in artifact `float_stats.txt`).
- CLI and API executions produce numerically consistent outputs (within 1e-6 relative tolerance per `nb-compare` ROI check).
- No regressions in HKL cache loading (verify with existing tests targeting HKL/Fdump behaviour, e.g., `tests/test_hkl_cache.py` if available).

## Risk Log
- **Cached Fdump collisions:** A stale `Fdump.bin` may still exist from older runs; ensure plan includes explicit instructions to remove or ignore it during validation.
- **Downstream dependency:** Other CLI commands may rely on the sentinel key; confirm no code assumes `config['hkl_data']` exists unconditionally.
- **Testing coverage:** If `tests/test_at_cli_002.py` is the only guard, consider adding a smoke test to the CLI integration suite to prevent regressions.

## References
- Phase B callchain artifacts: `reports/2026-01-test-suite-triage/phase_d/20251010T160902Z/cli-defaults/phase_b/`
- Spec: `specs/spec-a-cli.md` §AT-CLI-002
- Implementation references: `src/nanobrag_torch/__main__.py` lines 432-456 & 1087-1100, `src/nanobrag_torch/models/crystal.py` lines 225-233, `src/nanobrag_torch/io/hkl.py`
