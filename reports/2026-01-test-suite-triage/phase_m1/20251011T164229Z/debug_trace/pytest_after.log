============================= test session starts ==============================
platform linux -- Python 3.13.5, pytest-8.4.1, pluggy-1.5.0 -- /home/ollie/miniconda3/bin/python3.13
cachedir: .pytest_cache
rootdir: /home/ollie/Documents/tmp/nanoBragg
configfile: pyproject.toml
plugins: anyio-4.9.0
collecting ... collected 1 item

tests/test_debug_trace.py::TestDebugTraceFeatures::test_trace_pixel_flag FAILED [100%]

=================================== FAILURES ===================================
_________________ TestDebugTraceFeatures.test_trace_pixel_flag _________________

self = <tests.test_debug_trace.TestDebugTraceFeatures object at 0x7b1d1df91f30>
minimal_args = ['-cell', '100', '100', '100', '90', '90', ...]

    def test_trace_pixel_flag(self, minimal_args):
        """Test that -trace_pixel produces detailed trace for specific pixel."""
        with tempfile.NamedTemporaryFile(suffix='.bin', delete=False) as f:
            output_file = f.name
    
        try:
            # Run with -trace_pixel flag for pixel (32, 32) [slow, fast]
            cmd = ['python', '-m', 'nanobrag_torch'] + minimal_args + [
                '-floatfile', output_file,
                '-trace_pixel', '32', '32'
            ]
    
            result = subprocess.run(
                cmd,
                capture_output=True,
                text=True,
                env={**os.environ, 'KMP_DUPLICATE_LIB_OK': 'TRUE'}
            )
    
            # Check that the command succeeded
            assert result.returncode == 0, f"Command failed: {result.stderr}"
    
            # Check for trace output markers
            output = result.stdout
            assert "Tracing pixel" in output or "TRACE:" in output
    
            # Should have detailed trace information
            if "TRACE:" in output:
                assert "Final intensity" in output or "intensity =" in output
>               assert "Position" in output or "Airpath" in output
E               AssertionError: assert ('Position' in 'Running simulation...\n  Detector: 64x64 pixels\n  Crystal: 100.0x100.0x100.0 Å\n  Wavelength: 1.00 Å\n  Device: cpu, Dtype: torch.float32\n  Tracing pixel (slow=32, fast=32)\nauto-selected 2-fold oversampling\nTRACE_PY: pix0_vector_meters 0.100000001490116 0.00329999998211861 -0.00329999998211861\nTRACE_PY: fdet_vec 0 0 1\nTRACE_PY: sdet_vec 0 -1 0\nTRACE_PY: pixel_pos_meters 0.100000001490116 5.00001478940248e-05 -5.00001478940248e-05\nTRACE_PY: R_distance_meters 0.100000031292439\nTRACE_PY: omega_pixel_sr 9.99999087980541e-07\nTRACE_PY: close_distance_meters 0.100000001490116\nTRACE_PY: obliquity_factor 0.999999701976776\nTRACE_PY: diffracted_vec 0.999999761581421 0.000500001362524927 -0.000500001362524927\nTRACE_PY: incident_vec 1 0 0\nTRACE_PY: lambda_meters 1e-10\nTRACE_PY: lambda_angstroms 1\nTRACE_PY: scattering_vec_A_inv -2384.18579101562 5000013.5 -5000013.5\nTRACE_PY: rot_a_angstroms 1.00000017155821e-08 -4.37113946468983e-16 -4.37113972938762e-16\nTRACE_PY: rot_b_angstroms 0 1.00000017155821e-08 -4.37113946468983e-16\nTRACE_PY: rot_c_angstroms 0 0 1.00000008274037e-08\nTRACE_PY: spindle_axis_raw 0 0 1\nTRACE_PY: spindle_axis_normalized 0 0 1\nTRACE_PY: spindle_magnit...att_b 5\nTRACE_PY: F_latt_c 5\nTRACE_PY: F_latt 125\nTRACE_PY: F_cell_interpolated 100\nTRACE_PY: F_cell_nearest 100\nTRACE_PY: I_before_scaling_pre_polar 389121536\nTRACE_PY: I_before_scaling_post_polar 389121408\nTRACE_PY: r_e_meters 2.81794118441937e-15\nTRACE_PY: r_e_sqr 7.9407927259064e-30\nTRACE_PY: fluence_photons_per_m2 1.25932017574725e+29\nTRACE_PY: steps 4\nTRACE_PY: oversample_thick 0\nTRACE_PY: oversample_polar 0\nTRACE_PY: oversample_omega 0\nTRACE_PY: capture_fraction 1\nTRACE_PY: polar 1\nTRACE_PY: omega_pixel 9.99999087980541e-07\nTRACE_PY: cos_2theta 0.999999761581421\nTRACE_PY: I_pixel_final 97.2803268432617\nTRACE_PY: floatimage_accumulated 97.2803268432617\n\nFinal intensity = 9.728033e+01\nNormalized intensity = 3.891213e+02\nTRACE: r_e^2 = 7.940792725906e-30\nTRACE: Fluence = 1.259320175747e+29\nTRACE: Oversample = 2\n\nTRACE: Intensity calculation chain:\n  normalized * r_e^2 * fluence\n  = 3.891212768555e+02 * 7.940792725906e-30 * 1.259320175747e+29\n  = 9.728032684326e+01\n\nStatistics:\n  Max intensity: 9.728e+01 at pixel (33, 33)\n  Mean: 6.151e+00\n  RMS: 1.881e+01\n  RMSD: 1.778e+01\nWrote float image to /tmp/tmpdui_l7rd.bin\n\nSimulation complete.\n' or 'Airpath' in 'Running simulation...\n  Detector: 64x64 pixels\n  Crystal: 100.0x100.0x100.0 Å\n  Wavelength: 1.00 Å\n  Device: cpu, Dtype: torch.float32\n  Tracing pixel (slow=32, fast=32)\nauto-selected 2-fold oversampling\nTRACE_PY: pix0_vector_meters 0.100000001490116 0.00329999998211861 -0.00329999998211861\nTRACE_PY: fdet_vec 0 0 1\nTRACE_PY: sdet_vec 0 -1 0\nTRACE_PY: pixel_pos_meters 0.100000001490116 5.00001478940248e-05 -5.00001478940248e-05\nTRACE_PY: R_distance_meters 0.100000031292439\nTRACE_PY: omega_pixel_sr 9.99999087980541e-07\nTRACE_PY: close_distance_meters 0.100000001490116\nTRACE_PY: obliquity_factor 0.999999701976776\nTRACE_PY: diffracted_vec 0.999999761581421 0.000500001362524927 -0.000500001362524927\nTRACE_PY: incident_vec 1 0 0\nTRACE_PY: lambda_meters 1e-10\nTRACE_PY: lambda_angstroms 1\nTRACE_PY: scattering_vec_A_inv -2384.18579101562 5000013.5 -5000013.5\nTRACE_PY: rot_a_angstroms 1.00000017155821e-08 -4.37113946468983e-16 -4.37113972938762e-16\nTRACE_PY: rot_b_angstroms 0 1.00000017155821e-08 -4.37113946468983e-16\nTRACE_PY: rot_c_angstroms 0 0 1.00000008274037e-08\nTRACE_PY: spindle_axis_raw 0 0 1\nTRACE_PY: spindle_axis_normalized 0 0 1\nTRACE_PY: spindle_magnit...att_b 5\nTRACE_PY: F_latt_c 5\nTRACE_PY: F_latt 125\nTRACE_PY: F_cell_interpolated 100\nTRACE_PY: F_cell_nearest 100\nTRACE_PY: I_before_scaling_pre_polar 389121536\nTRACE_PY: I_before_scaling_post_polar 389121408\nTRACE_PY: r_e_meters 2.81794118441937e-15\nTRACE_PY: r_e_sqr 7.9407927259064e-30\nTRACE_PY: fluence_photons_per_m2 1.25932017574725e+29\nTRACE_PY: steps 4\nTRACE_PY: oversample_thick 0\nTRACE_PY: oversample_polar 0\nTRACE_PY: oversample_omega 0\nTRACE_PY: capture_fraction 1\nTRACE_PY: polar 1\nTRACE_PY: omega_pixel 9.99999087980541e-07\nTRACE_PY: cos_2theta 0.999999761581421\nTRACE_PY: I_pixel_final 97.2803268432617\nTRACE_PY: floatimage_accumulated 97.2803268432617\n\nFinal intensity = 9.728033e+01\nNormalized intensity = 3.891213e+02\nTRACE: r_e^2 = 7.940792725906e-30\nTRACE: Fluence = 1.259320175747e+29\nTRACE: Oversample = 2\n\nTRACE: Intensity calculation chain:\n  normalized * r_e^2 * fluence\n  = 3.891212768555e+02 * 7.940792725906e-30 * 1.259320175747e+29\n  = 9.728032684326e+01\n\nStatistics:\n  Max intensity: 9.728e+01 at pixel (33, 33)\n  Mean: 6.151e+00\n  RMS: 1.881e+01\n  RMSD: 1.778e+01\nWrote float image to /tmp/tmpdui_l7rd.bin\n\nSimulation complete.\n')

tests/test_debug_trace.py:130: AssertionError
=========================== short test summary info ============================
FAILED tests/test_debug_trace.py::TestDebugTraceFeatures::test_trace_pixel_flag
============================== 1 failed in 4.70s ===============================
