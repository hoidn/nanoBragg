# PERF-PYTORCH-004 P3.0 Completion: Multi-Source Beam Defaults

**Date:** 2025-09-30
**Task:** Fix multi-source beam defaults before benchmarking
**Status:** COMPLETE ✅

## Problem Statement

`Simulator.__init__` crashed when `beam_config.source_wavelengths` or `beam_config.source_weights` were `None`, calling `.to(...)` on `NoneType` objects. This violated AT-SRC-001 default rules and blocked multi-source execution.

**Error before fix:**
```
AttributeError: 'NoneType' object has no attribute 'to'
```

## Solution

Modified `src/nanobrag_torch/simulator.py:427-453` to:
1. Check if `source_wavelengths` is None before calling `.to()`
2. Default to primary wavelength (`beam_config.wavelength_A * 1e-10`) for all sources if omitted
3. Default to equal weights (`torch.ones(n_sources)`) if `source_weights` is omitted

## Verification

### Test 1: Minimal Reproduction (PASSED ✅)
```python
beam_config = BeamConfig(
    wavelength_A=6.2,
    source_directions=torch.tensor([[1., 0., 0.], [0., 1., 0.], [-1., 0., 0.]])
    # source_wavelengths intentionally omitted
    # source_weights intentionally omitted
)
sim = Simulator(crystal, detector, beam_config=beam_config)
# Result: No crash, wavelengths default to [6.2, 6.2, 6.2] Å, weights to [1.0, 1.0, 1.0]
```

### Test 2: Multi-Source Integration Test (PASSED ✅)
```bash
$ env KMP_DUPLICATE_LIB_OK=TRUE pytest tests/test_multi_source_integration.py -v
tests/test_multi_source_integration.py::test_multi_source_intensity_normalization PASSED [100%]
============================== 1 passed in 6.31s ===============================
```

### Test 3: Core Geometry Regression (PASSED ✅)
```bash
$ env KMP_DUPLICATE_LIB_OK=TRUE pytest tests/test_crystal_geometry.py tests/test_detector_geometry.py -q
...............................
31 passed in 4.27s
```

## Files Modified

- `src/nanobrag_torch/simulator.py`: Lines 425-453 (P3.0 fix with inline comments)

## Next Actions

- P3.0b: Fix multi-source polarization (per-source incident directions)
- P3.0c: Restore multi-source intensity normalization parity
- P3.4: Cache ROI/misset tensors before benchmarking
- P3.2/P3.3: Rerun CPU/CUDA benchmarks after fixes land

## Exit Criteria Met

✅ Constructor no longer crashes with `source_wavelengths=None`
✅ Defaults match AT-SRC-001 spec (primary wavelength, equal weights)
✅ Multi-source integration test passes
✅ No regressions in core geometry tests

**Plan task P3.0 → COMPLETE**
