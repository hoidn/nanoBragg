# Phase 3: Golden Test Case Generation Checklist

**Initiative:** General and Differentiable Detector Geometry
**Created:** 2025-08-06
**Phase Goal:** To generate the cubic_tilted_detector golden test case with comprehensive trace data.
**Deliverable:** Complete golden test artifacts including high-precision trace logs of detector geometry.

---
## 🧠 **Critical Context for This Phase**

**Key Modules & APIs Involved:**
- `golden_suite_generator/nanoBragg.c`: Add trace statements for detector basis vectors
- `golden_suite_generator/generate_golden.sh`: Add cubic_tilted_detector case
- `tests/golden_data/cubic_tilted_detector/`: New directory for test artifacts

**⚠️ Potential Gotchas & Conventions to Respect:**
- Trace output must use %.15g format for full double precision
- Must trace: fdet_vec, sdet_vec, odet_vec, pix0_vector after all rotations
- Test parameters: twotheta=15°, beam_center offset by 10mm in both directions
- Include detector_rotx=5°, detector_roty=3°, detector_rotz=2° for comprehensive testing
---

## ✅ Task List

### Instructions:
1.  Work through tasks in order. Dependencies are noted in the guidance column.
2.  The **"How/Why & API Guidance"** column contains all necessary details for implementation.
3.  Update the `State` column as you progress: `[ ]` (Open) -> `[P]` (In Progress) -> `[D]` (Done).

---

| ID  | Task Description                                   | State | How/Why & API Guidance                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| :-- | :------------------------------------------------- | :---- | :------------------------------------------------- |
| **Section 0: Preparation & Analysis** | | | |
| 0.A | **Review Critical Context**                        | `[ ]` | **Why:** To prevent common errors by understanding the specific challenges of this phase. <br> **Action:** Carefully read the "Critical Context for This Phase" section above. Acknowledge that you understand the potential gotchas before proceeding. |
| 0.B | **Analyze Source Code**                            | `[ ]` | **Why:** To understand the existing code before modification. <br> **Action:** Open and read the files listed in the "Key Modules & APIs" section. Pay close attention to the function signatures, data flow, and any existing comments. |
| 0.C | **Check Existing Golden Test Structure**           | `[ ]` | **Why:** To understand the existing golden test pattern to replicate. <br> **Action:** Examine `tests/golden_data/simple_cubic/` directory structure and files. Note the file formats and naming conventions used (image.bin, trace.log, params.json, regenerate_golden.sh). |
| **Section 1: Implementation Tasks** | | | |
| 1.A | **Create Golden Test Directory**                   | `[ ]` | **Why:** To establish the directory structure for the new test case. <br> **File:** `tests/golden_data/cubic_tilted_detector/` <br> **API Guidance:** Create the directory using: `mkdir -p tests/golden_data/cubic_tilted_detector`. This follows the existing pattern from simple_cubic. |
| 1.B | **Add Detector Trace Statements to nanoBragg.c**   | `[ ]` | **Why:** To capture detector basis vectors for validation. <br> **File:** `golden_suite_generator/nanoBragg.c` <br> **API Guidance:** After line 1412 (after all detector rotations), add: <br>```c<br>printf("DETECTOR_FAST_AXIS %.15g %.15g %.15g\n", fdet_vector[1], fdet_vector[2], fdet_vector[3]);<br>printf("DETECTOR_SLOW_AXIS %.15g %.15g %.15g\n", sdet_vector[1], sdet_vector[2], sdet_vector[3]);<br>printf("DETECTOR_NORMAL_AXIS %.15g %.15g %.15g\n", odet_vector[1], odet_vector[2], odet_vector[3]);<br>printf("DETECTOR_PIX0_VECTOR %.15g %.15g %.15g\n", pix0_vector[1], pix0_vector[2], pix0_vector[3]);<br>``` <br>**Note:** C arrays are 1-indexed in nanoBragg.c |
| 1.C | **Create regenerate_golden.sh Script**             | `[ ]` | **Why:** To document exact parameters for reproducibility. <br> **File:** `tests/golden_data/cubic_tilted_detector/regenerate_golden.sh` <br> **API Guidance:** Create script with: <br>```bash<br>#!/bin/bash<br># Parameters: cubic cell, tilted detector with rotations<br>../../../golden_suite_generator/nanoBragg \<br>    -lambda 6.2 \<br>    -N 5 \<br>    -cell 100 100 100 90 90 90 \<br>    -hkl ../simple_cubic.hkl \<br>    -distance 100 \<br>    -detsize 102.4 \<br>    -detpixels 1024 \<br>    -Xbeam 61.2 -Ybeam 61.2 \<br>    -detector_rotx 5 -detector_roty 3 -detector_rotz 2 \<br>    -twotheta 15 \<br>    -oversample 1 \<br>    -floatfile image.bin \<br>    > trace.log 2>&1<br>``` <br>**Note:** Beam center offset by 10mm (61.2 - 51.2 = 10mm) |
| 1.D | **Create params.json File**                        | `[ ]` | **Why:** To store test parameters in machine-readable format. <br> **File:** `tests/golden_data/cubic_tilted_detector/params.json` <br> **API Guidance:** Create JSON with all parameters: <br>```json<br>{<br>  "wavelength_A": 6.2,<br>  "crystal_size_cells": 5,<br>  "unit_cell": {"a": 100, "b": 100, "c": 100, "alpha": 90, "beta": 90, "gamma": 90},<br>  "detector_distance_mm": 100,<br>  "detector_size_mm": 102.4,<br>  "detector_pixels": 1024,<br>  "beam_center_mm": {"x": 61.2, "y": 61.2},<br>  "detector_rotations_deg": {"x": 5, "y": 3, "z": 2},<br>  "twotheta_deg": 15,<br>  "oversample": 1<br>}<br>``` |
| 1.E | **Update generate_golden.sh Main Script**          | `[ ]` | **Why:** To add cubic_tilted_detector to the main generation script. <br> **File:** `golden_suite_generator/generate_golden.sh` <br> **API Guidance:** Add a new section after the simple_cubic case: <br>```bash<br>echo "Generating cubic_tilted_detector..."<br>cd ../tests/golden_data/cubic_tilted_detector<br>bash regenerate_golden.sh<br>cd ../../../golden_suite_generator<br>``` |
| 1.F | **Compile Updated nanoBragg.c**                    | `[ ]` | **Why:** To include the new trace statements. <br> **Command:** `cd golden_suite_generator && gcc -O3 -o nanoBragg nanoBragg.c -lm -fopenmp` <br> **Verify:** Check that compilation succeeds without warnings. |
| **Section 2: Testing & Validation** | | | |
| 2.A | **Generate Golden Test Data**                      | `[ ]` | **Why:** To create the reference data for the new test case. <br> **Command:** `cd tests/golden_data/cubic_tilted_detector && bash regenerate_golden.sh` <br> **Verify:** Check that image.bin and trace.log are created. |
| 2.B | **Verify Trace Output Format**                     | `[ ]` | **Why:** To ensure trace statements are working correctly. <br> **Command:** `grep "DETECTOR_" tests/golden_data/cubic_tilted_detector/trace.log` <br> **Verify:** You should see 4 lines with detector vectors, each with 3 numbers in %.15g format. |
| 2.C | **Validate Image File**                            | `[ ]` | **Why:** To ensure the golden image was generated correctly. <br> **Command:** `ls -la tests/golden_data/cubic_tilted_detector/image.bin` <br> **Verify:** File size should be 1024*1024*4 = 4,194,304 bytes (4 bytes per float). |
| 2.D | **Extract and Save Detector Vectors**              | `[ ]` | **Why:** To create a separate file for easy vector comparison. <br> **File:** `tests/golden_data/cubic_tilted_detector/detector_vectors.txt` <br> **Command:** `grep "DETECTOR_" trace.log > detector_vectors.txt` <br> **Note:** This makes it easier for PyTorch tests to load and compare vectors. |
| **Section 3: Finalization** | | | |
| 3.A | **Code Formatting & Cleanup**                      | `[ ]` | **Why:** To maintain code quality and project standards. <br> **How:** Review the added C code for consistent indentation. Ensure the trace statements follow the existing code style. |
| 3.B | **Document Trace Format**                          | `[ ]` | **Why:** To help future developers understand the trace output. <br> **File:** `tests/golden_data/README.md` <br> **Action:** Add a section documenting the new DETECTOR_* trace format and what each vector represents. |
| 3.C | **Verify All Files Present**                       | `[ ]` | **Why:** To ensure the test case is complete. <br> **Command:** `ls tests/golden_data/cubic_tilted_detector/` <br> **Expected files:** image.bin, trace.log, params.json, regenerate_golden.sh, detector_vectors.txt |

---

## 🎯 Success Criteria

**This phase is complete when:**
1.  All tasks in the table above are marked `[D]` (Done).
2.  The phase success test passes: Golden data generated with complete trace.log containing detector vectors.
3.  No regressions are introduced in the existing test suite.
4.  The cubic_tilted_detector directory contains all required artifacts: image.bin, trace.log, params.json, regenerate_golden.sh, and detector_vectors.txt
5.  The trace.log file contains high-precision (%.15g) detector basis vectors after all rotations have been applied