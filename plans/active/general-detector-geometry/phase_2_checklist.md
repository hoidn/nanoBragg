# Phase 2: Dynamic Basis Vector Calculation Checklist

**Initiative:** General and Differentiable Detector Geometry
**Created:** 2025-08-05
**Phase Goal:** To implement the _calculate_basis_vectors method that correctly applies all detector rotations and positioning.
**Deliverable:** A working implementation that matches C-code behavior for detector orientation and positioning.

---
## 🧠 **Critical Context for This Phase**

**Key Modules & APIs Involved:**
- `src/nanobrag_torch/models/detector.py`: Implement `_calculate_basis_vectors()` method
- `src/nanobrag_torch/utils/geometry.py`: Use existing `rotate()` and `rotate_axis()` functions
- `golden_suite_generator/nanoBragg.c`: Extract detector rotation logic (lines 1319-1412)

**⚠️ Potential Gotchas & Conventions to Respect:**
- Rotation order is critical: detector_rotx/y/z are applied first, then twotheta
- The detector pivot mode (SAMPLE vs BEAM) changes when pix0_vector is calculated
- The C-code uses 1-indexed arrays; PyTorch uses 0-indexed
- Initial basis vectors depend on detector convention (MOSFLM: f=[0,0,-1], s=[1,0,0] vs XDS: f=[1,0,0], s=[0,1,0])
- The twotheta rotation is around an arbitrary axis, not a coordinate axis
---

## ✅ Task List

### Instructions:
1.  Work through tasks in order. Dependencies are noted in the guidance column.
2.  The **"How/Why & API Guidance"** column contains all necessary details for implementation.
3.  Update the `State` column as you progress: `[ ]` (Open) -> `[P]` (In Progress) -> `[D]` (Done).

---

| ID  | Task Description                                   | State | How/Why & API Guidance                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| :-- | :------------------------------------------------- | :---- | :------------------------------------------------- |
| **Section 0: Preparation & Analysis** | | | |
| 0.A | **Review Critical Context**                        | `[D]` | **Why:** To prevent common errors by understanding the specific challenges of this phase. <br> **Action:** Carefully read the "Critical Context for This Phase" section above. Acknowledge that you understand the potential gotchas before proceeding. |
| 0.B | **Extract C-Code Reference (MANDATORY FIRST STEP)** | `[D]` | **Why:** This is a MANDATORY project convention per CLAUDE.md Rule #11. ALL ported functions MUST have C-code references BEFORE implementation. <br> **File:** `golden_suite_generator/nanoBragg.c` <br> **Action:** <br>1. Open the C file and locate lines 1319-1412 containing detector rotation logic <br>2. Extract the EXACT C-code including comments <br>3. Save this verbatim quote for use in Task 1.A <br>**Critical:** DO NOT paraphrase or summarize - copy EXACTLY as written |
| 0.C | **Analyze Rotation Conventions**                   | `[D]` | **Why:** To understand the exact order and conventions used in C-code. <br> **Action:** From the extracted C-code, identify: <br>1. Initial basis vector values for each convention <br>2. The exact order of rotations (rotx→roty→rotz→twotheta) <br>3. How pivot mode affects calculations <br>4. Which vectors get rotated when |
| **Section 1: Implementation Tasks** | | | |
| 1.A | **Create Function Stub with C-Code Reference**     | `[D]` | **Why:** MANDATORY per CLAUDE.md Rule #11 - C-code reference MUST be added BEFORE implementation. <br> **File:** `src/nanobrag_torch/models/detector.py` <br> **Action:** Replace the existing `_calculate_basis_vectors` method with: <br>```python<br>def _calculate_basis_vectors(self) -> Tuple[torch.Tensor, torch.Tensor, torch.Tensor]:<br>    """<br>    Calculate detector basis vectors from configuration.<br>    <br>    This method dynamically computes the detector's fast, slow, and<br>    normal basis vectors based on user-provided configuration, such as<br>    detector rotations (`-detector_rot*`) and the two-theta angle.<br>    <br>    C-Code Implementation Reference (from nanoBragg.c, lines 1319-1412):<br>    ```c<br>    [PASTE THE EXACT C-CODE EXTRACTED IN TASK 0.B HERE]<br>    ```<br>    <br>    Returns:<br>        Tuple of (fdet_vec, sdet_vec, odet_vec) basis vectors<br>    """<br>    # Implementation will go here in subsequent tasks<br>    raise NotImplementedError("To be implemented after C-code reference is added")<br>``` <br>**CRITICAL:** You MUST complete this task BEFORE any implementation |
| 1.B | **Implement Initial Basis Vector Setup**           | `[D]` | **Why:** Different conventions use different initial orientations. <br> **File:** `src/nanobrag_torch/models/detector.py` <br> **Action:** In `_calculate_basis_vectors`, implement: <br>```python<br>if self.config.detector_convention == DetectorConvention.MOSFLM:<br>    fdet = torch.tensor([0.0, 0.0, -1.0], device=self.device, dtype=self.dtype)<br>    sdet = torch.tensor([1.0, 0.0, 0.0], device=self.device, dtype=self.dtype)<br>    odet = torch.tensor([0.0, 1.0, 0.0], device=self.device, dtype=self.dtype)<br>else:  # XDS<br>    fdet = torch.tensor([1.0, 0.0, 0.0], device=self.device, dtype=self.dtype)<br>    sdet = torch.tensor([0.0, 1.0, 0.0], device=self.device, dtype=self.dtype)<br>    odet = torch.tensor([0.0, 0.0, 1.0], device=self.device, dtype=self.dtype)<br>``` |
| 1.C | **Import Geometry Functions**                      | `[D]` | **Why:** To use the rotation utilities from geometry module. <br> **File:** `src/nanobrag_torch/models/detector.py` <br> **Action:** Add at top of file: <br>`from ..utils.geometry import rotate, rotate_axis` |
| 1.D | **Implement Detector Rotations**                   | `[D]` | **Why:** Apply detector_rotx/y/z rotations in correct order. <br> **File:** `src/nanobrag_torch/models/detector.py` <br> **Action:** After initial setup, add: <br>```python<br># Convert rotation angles to radians<br>rotx = degrees_to_radians(self.config.detector_rotx_deg)<br>roty = degrees_to_radians(self.config.detector_roty_deg)<br>rotz = degrees_to_radians(self.config.detector_rotz_deg)<br><br># Apply detector rotations to all basis vectors<br>fdet = rotate(fdet, rotx, roty, rotz)<br>sdet = rotate(sdet, rotx, roty, rotz)<br>odet = rotate(odet, rotx, roty, rotz)<br>``` |
| 1.E | **Implement Two-theta Rotation**                   | `[D]` | **Why:** Apply rotation around arbitrary twotheta axis. <br> **File:** `src/nanobrag_torch/models/detector.py` <br> **Action:** After detector rotations, add: <br>```python<br># Apply two-theta rotation if non-zero<br>twotheta = degrees_to_radians(self.config.detector_twotheta_deg)<br>if torch.abs(twotheta) > 1e-10:  # Check for non-zero<br>    # Normalize twotheta axis<br>    axis = self.config.twotheta_axis / torch.norm(self.config.twotheta_axis)<br>    fdet = rotate_axis(fdet, axis, twotheta)<br>    sdet = rotate_axis(sdet, axis, twotheta)<br>    odet = rotate_axis(odet, axis, twotheta)<br>``` |
| 1.F | **Return Calculated Vectors**                      | `[D]` | **Why:** Complete the method implementation. <br> **Action:** At end of method: <br>`return fdet, sdet, odet` |
| **Section 2: Testing & Validation** | | | |
| 2.A | **Create Basic Rotation Tests**                    | `[D]` | **Why:** To verify individual rotations work correctly. <br> **File:** `tests/test_detector_geometry.py` (create new) <br> **Action:** Create tests for: <br>- Default vectors for MOSFLM and XDS conventions <br>- Single axis rotations (rotx only, roty only, etc.) <br>- Combined rotations match expected results |
| 2.B | **Test Two-theta Rotation**                        | `[D]` | **Why:** Two-theta uses arbitrary axis rotation. <br> **File:** `tests/test_detector_geometry.py` <br> **Action:** Add test: <br>```python<br>def test_twotheta_rotation():<br>    config = DetectorConfig(detector_twotheta_deg=15.0)<br>    detector = Detector(config)<br>    # Verify vectors are rotated by 15 degrees around Y axis<br>``` |
| 2.C | **Test Tensor Differentiability**                  | `[D]` | **Why:** Ensure gradients flow through rotations. <br> **File:** `tests/test_detector_geometry.py` <br> **Action:** Test that basis vectors maintain gradients when config parameters are tensors with requires_grad=True |
| 2.D | **Run Updated Tests**                              | `[D]` | **Why:** To verify the implementation works. <br> **Command:** `KMP_DUPLICATE_LIB_OK=TRUE pytest tests/test_detector_geometry.py -v` <br> **Also run:** `KMP_DUPLICATE_LIB_OK=TRUE pytest tests/test_detector_config.py -v` to ensure no regressions |
| **Section 3: Integration & Cleanup** | | | |
| 3.A | **Update Detector Tests**                          | `[D]` | **Why:** Remove skip decorators now that _calculate_basis_vectors is implemented. <br> **File:** `tests/test_detector_config.py` <br> **Action:** Remove `@pytest.mark.skip` from: <br>- `test_custom_config_initialization` <br>- `test_custom_config_not_default` |
| 3.B | **Verify Backward Compatibility**                  | `[D]` | **Why:** Ensure simple_cubic still works. <br> **Command:** `KMP_DUPLICATE_LIB_OK=TRUE pytest tests/test_suite.py::TestTier1TranslationCorrectness::test_simple_cubic_reproduction -v` <br> **Expected:** Test should still pass with >0.99 correlation |
| **Section 4: Finalization** | | | |
| 4.A | **Code Formatting & Cleanup**                      | `[D]` | **Why:** Maintain code quality. <br> **Action:** <br>1. Remove the NotImplementedError from _calculate_basis_vectors <br>2. Ensure proper indentation and formatting <br>3. Remove any debug prints |
| 4.B | **Update Method Docstring**                        | `[D]` | **Why:** Document the implementation. <br> **Action:** Update the _calculate_basis_vectors docstring to include: <br>- Parameter descriptions (even though it takes no parameters) <br>- Detailed description of the rotation order <br>- Note about device and dtype preservation |
| 4.C | **Commit Phase 2 Changes**                         | `[D]` | **Why:** Create a clean checkpoint. <br> **Command:** <br>```bash<br>git add -A<br>git commit -m "feat(detector): Implement dynamic basis vector calculation<br><br>- Add _calculate_basis_vectors with full C-code reference<br>- Support MOSFLM and XDS detector conventions<br>- Apply detector rotations (rotx/y/z) in correct order<br>- Implement two-theta rotation around arbitrary axis<br>- Add comprehensive tests for rotations<br>- Maintain differentiability for all rotation parameters<br><br>Phase 2/5 of general detector geometry implementation."<br>``` |

---

## 🎯 Success Criteria

**This phase is complete when:**
1.  All tasks in the table above are marked `[D]` (Done).
2.  The C-code reference is properly included in the method docstring BEFORE implementation.
3.  Basis vectors are calculated dynamically based on DetectorConfig.
4.  All rotation parameters (rotx/y/z, twotheta) are applied in the correct order.
5.  Tests verify correct rotation behavior for individual and combined rotations.
6.  Backward compatibility is maintained (simple_cubic test still passes).
7.  Gradients flow correctly through tensor rotation parameters.