# Phase 4: Integration and Backward Compatibility Checklist

**Initiative:** General and Differentiable Detector Geometry
**Created:** 2025-08-06
**Phase Goal:** To integrate the new dynamic detector with the simulator while maintaining backward compatibility.
**Deliverable:** Updated Detector class that works for both simple_cubic and cubic_tilted_detector cases.

---
## 🧠 **Critical Context for This Phase**

**Key Modules & APIs Involved:**
- `src/nanobrag_torch/models/detector.py`: Update `get_pixel_coords()` to use calculated basis
- `tests/test_suite.py`: Add `test_cubic_tilted_detector_reproduction`
- `src/nanobrag_torch/simulator.py`: Ensure simulator passes DetectorConfig correctly
- `scripts/verify_detector_geometry.py`: Create new script for visual validation

**⚠️ Potential Gotchas & Conventions to Respect:**
- The simple_cubic test uses hard-coded values that must still work
- When DetectorConfig is None or uses defaults, must reproduce hard-coded behavior exactly
- The pixel coordinate generation depends on correct basis vectors and pix0_vector
- Coordinate system convention: pixels are indexed as (slow, fast) matching fabio/matplotlib
---

## ✅ Task List

### Instructions:
1.  Work through tasks in order. Dependencies are noted in the guidance column.
2.  The **"How/Why & API Guidance"** column contains all necessary details for implementation.
3.  Update the `State` column as you progress: `[ ]` (Open) -> `[P]` (In Progress) -> `[D]` (Done).

---

| ID  | Task Description                                   | State | How/Why & API Guidance                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       -
| :-- | :------------------------------------------------- | :---- | :-------------------------------------------------
| **Section 0: Preparation & Analysis**
| 0.A | **Review Critical Context**                        | `[D]` | **Why:** To prevent common errors by understanding the specific challenges of this phase. <br> **Action:** Carefully read the "Critical Context for This Phase" section above. Acknowledge that you understand the potential gotchas before proceeding.
| 0.B | **Analyze Source Code**                            | `[D]` | **Why:** To understand the existing code before modification. <br> **Action:** Open and read the files listed in the "Key Modules & APIs" section. Pay close attention to the function signatures, data flow, and any existing comments.
| **Section 1: Core Integration - Update get_pixel_coords**
| 1.A | **Implement: Update get_pixel_coords to use dynamic basis vectors** | `[D]` | **Why:** To enable the detector to use the calculated basis vectors instead of hard-coded ones. <br> **File:** `src/nanobrag_torch/models/detector.py` <br> **API Guidance:** Modify the `get_pixel_coords()` method to: <br>1. Remove hard-coded basis vector usage in the else branch of `_is_default_config()` <br>2. Use `self.fdet_vec`, `self.sdet_vec`, and `self.odet_vec` that are now dynamically calculated <br>3. Calculate pix0_vector = detector_origin + (0.5 - beam_center_s) * pixel_size * sdet_vec + (0.5 - beam_center_f) * pixel_size * fdet_vec <br>4. Ensure the pixel coordinate calculation matches: pixel_coords = pix0_vector + s * pixel_size * sdet_vec + f * pixel_size * fdet_vec
| 1.B | **Implement: Add pix0_vector calculation and caching** | `[D]` | **Why:** To correctly position the first pixel in 3D space based on detector geometry and beam center. <br> **File:** `src/nanobrag_torch/models/detector.py` <br> **API Guidance:** <br>1. Add `self.pix0_vector` as a cached property in `__init__` <br>2. Calculate it based on detector origin, beam center offset, and basis vectors <br>3. Update cache invalidation logic to include pix0_vector <br>4. Ensure it matches C-code PIX0_VECTOR trace output for validation
| **Section 2: Integration Testing**
| 2.A | **Add test_cubic_tilted_detector_reproduction**   | `[D]` | **Why:** To verify the new implementation correctly reproduces the tilted detector golden data. <br> **File:** `tests/test_suite.py` <br> **Guidance:** <br>1. Copy the structure from `test_simple_cubic_reproduction` <br>2. Load cubic_tilted_detector golden data from `tests/golden_data/cubic_tilted_detector/` <br>3. Create DetectorConfig with tilted parameters: twotheta=15°, rotx=5°, roty=3°, rotz=2°, beam_center offset <br>4. Run simulation and compute Pearson correlation <br>5. Assert correlation ≥ 0.990
| 2.B | **Verify backward compatibility test**             | `[D]` | **Why:** To ensure existing functionality is not broken by the changes. <br> **File:** `tests/test_suite.py` <br> **Guidance:** <br>1. Run `test_simple_cubic_reproduction` without any modifications <br>2. Verify it still passes with the same correlation threshold <br>3. Check that default DetectorConfig reproduces hard-coded behavior <br>4. Ensure no performance regression (timing should be within 5%)
| 2.C | **Create Visual Verification Script & Artifacts**  | `[D]` | **Why:** To provide a quick, intuitive visual confirmation that the detector geometry is correct and to generate assets for documentation. <br> **Action:** Create a new script `scripts/verify_detector_geometry.py`. This script must: <br>1. Setup: Instantiate two Detector objects: one with default (simple cubic) config, one with cubic_tilted_detector config. <br>2. Simulate: Run the Simulator for both detector configurations to generate two images. <br>3. Analyze: For each image, find the coordinates of the top 5 brightest pixels. <br>4. Save Images: Save three PNG images to a `reports/detector_verification/` directory: <br> - 01_detector_baseline.png (simple cubic) <br> - 02_detector_tilted.png (tilted) <br> - 03_detector_difference_heatmap.png (log-scaled absolute difference) <br>5. Print Report: Output a concise summary to the console comparing the spot positions and confirming that the pattern has rotated as expected.
| 2.D | **Add detector vector comparison test**            | `[D]` | **Why:** To ensure the calculated basis vectors exactly match the C-code reference. <br> **File:** `tests/test_detector_geometry.py` (create new) <br> **Guidance:** <br>1. Parse detector vectors from `tests/golden_data/cubic_tilted_detector/detector_vectors.txt` <br>2. Create DetectorConfig with same parameters <br>3. Compare PyTorch detector.fdet_vec, sdet_vec, odet_vec with parsed values <br>4. Assert torch.allclose with atol=1e-9 for all vectors <br>5. Also compare pix0_vector if available in trace
| **Section 3: Simulator Integration**
| 3.A | **Update Simulator to pass DetectorConfig**        | `[D]` | **Why:** To enable the simulator to use custom detector configurations. <br> **File:** `src/nanobrag_torch/simulator.py` <br> **API Guidance:** <br>1. Update `__init__` to accept optional `detector_config: Optional[DetectorConfig] = None` <br>2. Pass detector_config to Detector constructor: `self.detector = Detector(config=detector_config, device=self.device, dtype=self.dtype)` <br>3. Ensure None config still works (backward compatibility) <br>4. Update any method signatures that create Detector instances
| 3.B | **Add detector config to run_simulation interface** | `[D]` | **Why:** To expose detector configuration at the top-level API. <br> **File:** `src/nanobrag_torch/simulator.py` <br> **Guidance:** <br>1. Update `run_simulation()` function signature to accept `detector_config` parameter <br>2. Pass through to Simulator constructor <br>3. Update docstring with detector config examples <br>4. Test with both None and custom configs
| **Section 4: Performance & Edge Cases**
| 4.A | **Implement geometry caching strategy**            | `[D]` | **Why:** To avoid recalculating basis vectors when configuration hasn't changed. <br> **File:** `src/nanobrag_torch/models/detector.py` <br> **Guidance:** <br>1. Add `_geometry_version` counter in `__init__` <br>2. Increment version when any geometric parameter changes <br>3. Check version before recalculating in get_pixel_coords <br>4. Profile to ensure caching improves performance
| 4.B | **Test extreme rotation angles**                   | `[D]` | **Why:** To verify robustness of rotation calculations. <br> **File:** `tests/test_detector_geometry.py` <br> **Guidance:** <br>1. Test with 90°, 180°, -90° rotations on each axis <br>2. Test combined rotations (e.g., rotx=90°, roty=90°) <br>3. Verify basis vectors remain orthonormal <br>4. Check for gimbal lock or numerical instabilities
| 4.C | **Validate coordinate system conventions**         | `[D]` | **Why:** To ensure pixel ordering is consistent with expected conventions. <br> **File:** `tests/test_detector_geometry.py` <br> **Guidance:** <br>1. Create test comparing pixel coords with known positions <br>2. Verify (0,0) is at expected corner (depends on convention) <br>3. Check meshgrid indexing="ij" produces correct (slow, fast) order <br>4. Compare with fabio/matplotlib image orientation
| **Section 5: Finalization**
| 5.A | **Code Formatting & Linting**                      | `[D]` | **Why:** To maintain code quality and project standards. <br> **How:** Review code for consistent indentation, remove any debug prints, ensure proper docstrings for new functions.
| 5.B | **Update Function Docstrings**                     | `[D]` | **Why:** To document new parameters and functionality. <br> **How:** Update docstrings for any modified functions to reflect the changes made in this phase.
| 5.C | **Run Full Test Suite**                           | `[D]` | **Why:** To confirm all changes are working correctly. <br> **Command:** `pytest tests/ -v` <br> **Verify:** All tests must pass, including new cubic_tilted_detector test.

---

## 🎯 Success Criteria

**This phase is complete when:**
1.  All tasks in the table above are marked `[D]` (Done).
2.  The phase success test passes: Both simple_cubic and cubic_tilted_detector achieve ≥0.990 correlation.
3.  No regressions are introduced in the existing test suite.