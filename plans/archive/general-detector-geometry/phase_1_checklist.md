# Phase 1: DetectorConfig and Unit Conversion Foundation Checklist

**Initiative:** General and Differentiable Detector Geometry
**Created:** 2025-08-05
**Phase Goal:** To implement a complete DetectorConfig dataclass with all necessary geometric parameters and establish the unit conversion framework.
**Deliverable:** A fully populated `DetectorConfig` class with unit conversion methods and basic validation.

---
## 🧠 **Critical Context for This Phase**

**Key Modules & APIs Involved:**
- `src/nanobrag_torch/config.py`: Complete the `DetectorConfig` dataclass
- `src/nanobrag_torch/models/detector.py`: Update `__init__` to accept DetectorConfig
- `src/nanobrag_torch/utils/units.py`: Create new file for unit conversion utilities

**⚠️ Potential Gotchas & Conventions to Respect:**
- The DetectorConfig must accept user-friendly units (mm) but all internal calculations use Angstroms
- Parameters that need tensor support: distance, beam_center_s/f, all rotation angles
- The detector convention (MOSFLM vs XDS) affects the initial orientation of basis vectors
- Beam center can be specified as either (Xbeam, Ybeam) in mm or (ORGX, ORGY) in pixels
---

## ✅ Task List

### Instructions:
1.  Work through tasks in order. Dependencies are noted in the guidance column.
2.  The **"How/Why & API Guidance"** column contains all necessary details for implementation.
3.  Update the `State` column as you progress: `[ ]` (Open) -> `[P]` (In Progress) -> `[D]` (Done).

---

| ID  | Task Description                                   | State | How/Why & API Guidance                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| :-- | :------------------------------------------------- | :---- | :------------------------------------------------- |
| **Section 0: Preparation & Analysis** | | | |
| 0.A | **Review Critical Context**                        | `[ ]` | **Why:** To prevent common errors by understanding the specific challenges of this phase. <br> **Action:** Carefully read the "Critical Context for This Phase" section above. Acknowledge that you understand the potential gotchas before proceeding. |
| 0.B | **Analyze Source Code**                            | `[ ]` | **Why:** To understand the existing code before modification. <br> **Action:** Open and read the files listed in the "Key Modules & APIs" section. Pay close attention to the function signatures, data flow, and any existing comments. |
| 0.C | **Review C Parameter Dictionary**                  | `[ ]` | **Why:** To understand all detector parameters from the C-code that need to be implemented. <br> **Action:** Read `docs/architecture/c_parameter_dictionary.md` and identify all detector-related parameters including defaults and units. |
| **Section 1: Implementation Tasks** | | | |
| 1.A | **Create Unit Conversion Utilities**               | `[ ]` | **Why:** To establish consistent unit conversions before implementing the config. <br> **File:** `src/nanobrag_torch/utils/units.py` (create new) <br> **API Guidance:** Create functions: <br>- `mm_to_angstroms(value)` - multiply by 10.0 <br>- `meters_to_angstroms(value)` - multiply by 1e10 <br>- `degrees_to_radians(value)` - use torch.deg2rad() <br>- Ensure all functions preserve tensor properties and gradients |
| 1.B | **Define DetectorConvention Enum**                 | `[ ]` | **Why:** To support both MOSFLM and XDS detector conventions which affect initial basis vectors. <br> **File:** `src/nanobrag_torch/config.py` <br> **API Guidance:** Add before DetectorConfig: <br>```python<br>from enum import Enum<br><br>class DetectorConvention(Enum):<br>    MOSFLM = "mosflm"<br>    XDS = "xds"<br>``` |
| 1.C | **Define DetectorPivot Enum**                      | `[ ]` | **Why:** To support both BEAM and SAMPLE pivot modes which affect rotation behavior. <br> **File:** `src/nanobrag_torch/config.py` <br> **API Guidance:** Add after DetectorConvention: <br>```python<br>class DetectorPivot(Enum):<br>    BEAM = "beam"<br>    SAMPLE = "sample"<br>``` |
| 1.D | **Implement DetectorConfig Dataclass**             | `[ ]` | **Why:** To provide a complete configuration structure for detector geometry. <br> **File:** `src/nanobrag_torch/config.py` <br> **API Guidance:** Replace the empty DetectorConfig with: <br>```python<br>@dataclass<br>class DetectorConfig:<br>    # Basic geometry (user units: mm)<br>    distance_mm: Union[float, torch.Tensor] = 100.0<br>    pixel_size_mm: Union[float, torch.Tensor] = 0.1<br>    <br>    # Detector dimensions<br>    spixels: int = 1024  # slow axis pixels<br>    fpixels: int = 1024  # fast axis pixels<br>    <br>    # Beam center (mm from detector origin)<br>    beam_center_s: Union[float, torch.Tensor] = 51.2  # slow axis<br>    beam_center_f: Union[float, torch.Tensor] = 51.2  # fast axis<br>    <br>    # Detector rotations (degrees)<br>    detector_rotx_deg: Union[float, torch.Tensor] = 0.0<br>    detector_roty_deg: Union[float, torch.Tensor] = 0.0<br>    detector_rotz_deg: Union[float, torch.Tensor] = 0.0<br>    <br>    # Two-theta rotation (degrees)<br>    detector_twotheta_deg: Union[float, torch.Tensor] = 0.0<br>    twotheta_axis: torch.Tensor = None  # Will default to [0,1,0]<br>    <br>    # Convention and pivot<br>    detector_convention: DetectorConvention = DetectorConvention.MOSFLM<br>    detector_pivot: DetectorPivot = DetectorPivot.SAMPLE<br>    <br>    # Sampling<br>    oversample: int = 1<br>``` |
| 1.E | **Add Post-Init Validation**                       | `[ ]` | **Why:** To ensure config values are valid and set defaults. <br> **File:** `src/nanobrag_torch/config.py` <br> **API Guidance:** Add to DetectorConfig: <br>```python<br>def __post_init__(self):<br>    # Set default twotheta axis if not provided<br>    if self.twotheta_axis is None:<br>        self.twotheta_axis = torch.tensor([0.0, 1.0, 0.0])<br>    <br>    # Validate pixel counts<br>    if self.spixels <= 0 or self.fpixels <= 0:<br>        raise ValueError("Pixel counts must be positive")<br>    <br>    # Validate distance and pixel size<br>    if isinstance(self.distance_mm, (int, float)):<br>        if self.distance_mm <= 0:<br>            raise ValueError("Distance must be positive")<br>``` |
| 1.F | **Update Detector.__init__ Signature**             | `[ ]` | **Why:** To accept the new DetectorConfig instead of individual parameters. <br> **File:** `src/nanobrag_torch/models/detector.py` <br> **API Guidance:** Change `__init__` signature from: <br>`def __init__(self, distance_mm=100.0, ...):`<br>to:<br>`def __init__(self, config: Optional[DetectorConfig] = None):`<br>Import DetectorConfig at top of file. |
| 1.G | **Implement Config Processing in Detector**        | `[ ]` | **Why:** To use config values and convert units properly. <br> **File:** `src/nanobrag_torch/models/detector.py` <br> **API Guidance:** In `__init__`, add after config parameter: <br>```python<br>if config is None:<br>    config = DetectorConfig()  # Use defaults<br>self.config = config<br><br># Convert units to internal Angstrom system<br>from ..utils.units import mm_to_angstroms, degrees_to_radians<br>self.distance = mm_to_angstroms(config.distance_mm)<br>self.pixel_size = mm_to_angstroms(config.pixel_size_mm)<br>``` |
| 1.H | **Add Backward Compatibility Check**               | `[ ]` | **Why:** To ensure simple_cubic test continues to work with hard-coded values. <br> **File:** `src/nanobrag_torch/models/detector.py` <br> **API Guidance:** Add method: <br>```python<br>def _is_default_config(self) -> bool:<br>    """Check if using default config (for backward compatibility)."""<br>    c = self.config<br>    return (c.distance_mm == 100.0 and c.pixel_size_mm == 0.1 and<br>            c.spixels == 1024 and c.fpixels == 1024 and<br>            c.detector_rotx_deg == 0 and c.detector_roty_deg == 0 and<br>            c.detector_rotz_deg == 0 and c.detector_twotheta_deg == 0)<br>``` |
| **Section 2: Testing & Validation** | | | |
| 2.A | **Create Unit Tests for Units Module**             | `[ ]` | **Why:** To verify unit conversion functions work correctly. <br> **File:** `tests/test_units.py` (create new) <br> **Guidance:** Test:<br>- mm_to_angstroms: 1mm = 10Å<br>- degrees_to_radians: 180° = π rad<br>- Tensor inputs preserve gradients<br>- Batch tensor inputs work correctly |
| 2.B | **Create DetectorConfig Tests**                    | `[ ]` | **Why:** To verify configuration validation and defaults. <br> **File:** `tests/test_detector_config.py` (create new) <br> **Guidance:** Test:<br>- Default values are set correctly<br>- Invalid values raise appropriate errors<br>- Tensor parameters are accepted<br>- Post-init validation works |
| 2.C | **Run All Tests**                                  | `[ ]` | **Why:** To confirm the changes are working and have not broken other parts of the application. <br> **Command:** `KMP_DUPLICATE_LIB_OK=TRUE pytest tests/test_detector_config.py tests/test_units.py -v` <br> **Verify:** All new tests pass. |
| 2.D | **Run Simple Cubic Regression Test**               | `[ ]` | **Why:** To ensure backward compatibility is maintained. <br> **Command:** `KMP_DUPLICATE_LIB_OK=TRUE pytest tests/test_suite.py::TestTier1TranslationCorrectness::test_simple_cubic_reproduction -v` <br> **Verify:** Test still passes with correlation ≥ 0.990. |
| **Section 3: Finalization** | | | |
| 3.A | **Code Formatting & Linting**                      | `[ ]` | **Why:** To maintain code quality and project standards. <br> **How:** Review code for consistent indentation, remove any debug prints, ensure proper docstrings for new functions. |
| 3.B | **Update Function Docstrings**                     | `[ ]` | **Why:** To document new parameters and functionality. <br> **How:** Ensure all new classes and methods have comprehensive docstrings explaining parameters, return values, and units. |
| 3.C | **Commit Phase 1 Changes**                         | `[ ]` | **Why:** To create a clean checkpoint before moving to Phase 2. <br> **Command:** <br>```bash<br>git add -A<br>git commit -m "feat(detector): Implement DetectorConfig and unit conversion foundation<br><br>- Add DetectorConfig dataclass with all geometry parameters<br>- Create unit conversion utilities (mm→Å, degrees→radians)<br>- Update Detector to accept config instead of individual params<br>- Maintain backward compatibility for simple_cubic test<br>- Add comprehensive tests for config and units<br><br>Phase 1/5 of general detector geometry implementation."<br>``` |

---

## 🎯 Success Criteria

**This phase is complete when:**
1.  All tasks in the table above are marked `[D]` (Done).
2.  The phase success test passes: `pytest tests/test_detector_config.py` - all configuration tests pass.
3.  No regressions are introduced in the existing test suite.
4.  The DetectorConfig supports all necessary parameters with proper validation.
5.  Unit conversion utilities correctly handle both scalar and tensor inputs.