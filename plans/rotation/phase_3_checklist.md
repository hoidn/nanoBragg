### **Agent Implementation Checklist: Phase 3 - Validation and Golden Test Integration**

**Overall Goal for this Phase:** To validate the rotation implementation against C-code reference data and establish comprehensive test coverage.

**Instructions for Agent:**
1.  Copy this checklist into your working memory.
2.  Update the `State` for each item as you progress: `[ ]` (Open) -> `[P]` (In Progress) -> `[D]` (Done).
3.  Follow the `How/Why & API Guidance` column carefully for implementation details.

---

| ID  | Task Description                                   | State | How/Why & API Guidance                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
| :-- | :------------------------------------------------- | :---- | :-------------------------------------------------
| **Section 0: Preparation & Context Priming**
| 0.A | **Review Key Documents & APIs**                    | `[D]` | **Why:** To understand the validation requirements and C-code reference behavior. <br> **Docs:** `plans/rotation/implementation_rotation.md`, `docs/development/testing_strategy.md`, `CLAUDE.md` (golden test specifications). <br> **APIs:** `torch.corrcoef`, `torch.autograd.gradcheck`, `numpy.fromfile`.
| 0.B | **Identify Target Files for Creation/Modification**| `[D]` | **Why:** To have a clear list of files that will be created or modified during validation. <br> **Files:** `tests/golden_data/simple_cubic_mosaic.bin` (Create), `tests/test_suite.py` (Modify), `scripts/demo_rotation.py` (Create), `docs/rotation_usage.md` (Create).
| **Section 1: Golden Reference Data Generation**
| 1.A | **Generate C-code Reference with Mosaicity**       | `[D]` | **Why:** To create new golden reference data that includes mosaicity effects for validation. <br> **How:** Run the C nanoBragg with mosaicity parameters that exactly match the PyTorch test case (mosaic_domains=10). Save the output as simple_cubic_mosaic.bin. <br> **Command:** `./nanoBragg -hkl P1.hkl -matrix A.mat -lambda 6.2 -N 5 -mosaic_spread 1.0 -mosaic_domains 10 -default_F 100 -distance 100 -detsize 100 -pixel 0.1 -floatfile ../tests/golden_data/simple_cubic_mosaic.bin`.
| 1.B | **Verify Golden Data Quality**                     | `[D]` | **Why:** To ensure the golden reference shows expected mosaicity effects (spot broadening). <br> **How:** Load the generated data and verify it shows broader, more diffuse spots compared to the original `simple_cubic.bin`. Calculate spot width metrics. <br> **File:** Verify `tests/golden_data/simple_cubic_mosaic.bin`.
| **Section 2: Integration Test Implementation**
| 2.A | **Create simple_cubic_mosaic Integration Test**    | `[D]` | **Why:** To validate that the PyTorch implementation reproduces C-code mosaicity behavior. <br> **How:** Create `test_simple_cubic_mosaic_reproduction` in `TestTier1TranslationCorrectness`. Use `CrystalConfig(mosaic_spread_deg=1.0, mosaic_domains=100)` and compare against the golden data with >0.99 correlation requirement. <br> **File:** `tests/test_suite.py`.
| 2.B | **Implement Correlation Validation**               | `[D]` | **Why:** To quantitatively measure how well the PyTorch implementation matches the C-code. <br> **How:** Use `torch.corrcoef` to compare flattened images. Assert correlation > 0.99. Also check similar intensity scales (within factor of 2). <br> **File:** `tests/test_suite.py`.
| **Section 3: Gradient Correctness Testing**
| 3.A | **Create Gradient Test for phi Parameter**         | `[D]` | **Why:** To ensure phi rotation parameters are fully differentiable. <br> **How:** Create `test_gradcheck_phi_rotation` using `torch.autograd.gradcheck` on a scalar function that takes `phi_start_deg` and returns sum of simulation output. Use small phi range for numerical stability. <br> **File:** `tests/test_suite.py`.
| 3.B | **Create Gradient Test for mosaic_spread_deg**     | `[D]` | **Why:** To ensure mosaicity parameters are fully differentiable. <br> **How:** Create `test_gradcheck_mosaic_spread` using `torch.autograd.gradcheck` on a scalar function that takes `mosaic_spread_deg` and returns sum of simulation output. Use small mosaic spread for numerical stability. <br> **File:** `tests/test_suite.py`.
| 3.C | **Test Gradient Numerical Stability**              | `[D]` | **Why:** To verify gradients are stable and meaningful for optimization. <br> **How:** Test that gradient magnitudes are reasonable (not too large/small) and that small parameter changes produce expected gradient directions. <br> **File:** `tests/test_suite.py`.
| **Section 4: Demo Script and Documentation**
| 4.A | **Create Rotation Demo Script**                    | `[D]` | **Why:** To showcase the rotation capabilities and provide usage examples. <br> **How:** Create `scripts/demo_rotation.py` that generates a series of images showing: 1) No rotation, 2) Phi rotation series, 3) Mosaicity effects (no mosaic vs increasing mosaic). Save output images with descriptive names. <br> **File:** `scripts/demo_rotation.py`.
| 4.B | **Generate Demonstration Images**                   | `[D]` | **Why:** To visually demonstrate that mosaicity produces expected spot broadening effects. <br> **How:** Run the demo script and verify that: mosaic_spread=0 shows sharp spots, mosaic_spread>0 shows broader spots, increasing mosaic_spread increases broadening. <br> **File:** Generated image outputs from demo script.
| 4.C | **Create Usage Documentation**                      | `[D]` | **Why:** To document how to use the new rotation capabilities. <br> **How:** Create `docs/rotation_usage.md` with examples of CrystalConfig usage, parameter explanations, and links to demo script. Include code snippets for common use cases. <br> **File:** `docs/rotation_usage.md`.
| **Section 5: Finalization**
| 5.A | **Run Full Test Suite**                            | `[D]` | **Why:** To ensure all existing functionality still works with the new rotation features. <br> **How:** Run all tests in `tests/test_suite.py` and verify no regressions. All rotation tests should pass, including gradient checks. <br> **Command:** `python -m pytest tests/test_suite.py -v`.
| 5.B | **Code Quality and Documentation**                 | `[D]` | **Why:** To maintain code quality and completeness. <br> **How:** Run formatting tools if available. Ensure all new functions have proper docstrings. Update any relevant documentation files. <br> **Files:** All modified files.
| 5.C | **Performance Verification**                       | `[D]` | **Why:** To ensure rotation features don't significantly impact performance. <br> **How:** Compare simulation time with and without rotation. With default single orientation, performance should be similar. With multiple orientations, time should scale roughly linearly. <br> **Test:** Timing benchmarks.